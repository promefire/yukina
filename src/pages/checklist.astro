---
import MainLayout from '../layouts/MainLayout.astro';
---

<MainLayout title="æ¸…å•">
  <div class="checklist-container">
    <h1 class="page-title">æˆ‘çš„æ¸…å•</h1>
    
    <div class="category-tabs">
      <button class="tab-btn active" data-category="movies">ç”µå½±</button>
      <button class="tab-btn" data-category="books">å›¾ä¹¦</button>
      <button class="tab-btn" data-category="games">æ¸¸æˆ</button>
    </div>

    <div class="status-tabs">
      <div class="status-group" data-category="movies">
        <button class="status-btn active" data-status="watching">åœ¨çœ‹</button>
        <button class="status-btn" data-status="watched">çœ‹è¿‡</button>
        <button class="status-btn" data-status="wantToWatch">æƒ³çœ‹</button>
      </div>
      <div class="status-group hidden" data-category="books">
        <button class="status-btn active" data-status="reading">åœ¨è¯»</button>
        <button class="status-btn" data-status="read">è¯»è¿‡</button>
        <button class="status-btn" data-status="wantToRead">æƒ³è¯»</button>
      </div>
      <div class="status-group hidden" data-category="games">
        <button class="status-btn active" data-status="playing">åœ¨ç©</button>
        <button class="status-btn" data-status="played">ç©è¿‡</button>
        <button class="status-btn" data-status="wantToPlay">æƒ³ç©</button>
      </div>
    </div>

    <div class="content-area">
      <div class="loading hidden">åŠ è½½ä¸­...</div>
      <div class="error hidden">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>
      <div class="items-list" id="items-container"></div>
    </div>
  </div>
</MainLayout>

<style>
/* --- å…¨å±€å’Œæ ‡ç­¾æ ·å¼ (æ— æ”¹åŠ¨) --- */
  .checklist-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }
  .page-title {
    text-align: center;
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 2rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .category-tabs {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  .tab-btn {
    padding: 0.75rem 2rem;
    border: none;
    border-radius: 25px;
    background: #f3f4f6;
    color: #6b7280;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  .tab-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }
  .tab-btn:hover:not(.active) {
    background: #e5e7eb;
    transform: translateY(-1px);
  }
  .status-tabs {
    display: flex;
    justify-content: center;
    margin-bottom: 2rem;
  }
  .status-group {
    display: flex;
    gap: 0.5rem;
    padding: 0.5rem;
    background: #f9fafb;
    border-radius: 15px;
    border: 1px solid #e5e7eb;
  }
  .status-btn {
    padding: 0.5rem 1.5rem;
    border: none;
    border-radius: 10px;
    background: transparent;
    color: #6b7280;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .status-btn.active {
    background: white;
    color: #4f46e5;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  .status-btn:hover:not(.active) {
    color: #374151;
  }
  .content-area {
    min-height: 400px;
  }

/* --- MODIFIED: æ¸…ç†å’Œç®€åŒ–çš„ç½‘æ ¼å¸ƒå±€ä¸å¡ç‰‡æ‚¬åœæ•ˆæœ --- */
  .items-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1.5rem;
  }

  .item-card {
    display: block; /* è®© <a> æ ‡ç­¾è¡¨ç°å¾—åƒå—çº§å…ƒç´  */
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    aspect-ratio: 2 / 3;
    background-color: #e5e7eb; /* åŠ è½½æ—¶å ä½ç¬¦é¢œè‰² */
    text-decoration: none; /* å»é™¤é“¾æ¥ä¸‹åˆ’çº¿ */
  }

  .item-card:hover {
    transform: translateY(-5px) scale(1.03);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
  }

  .item-poster {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  

  


/* --- çŠ¶æ€å’Œå“åº”å¼æ ·å¼ (æ— æ”¹åŠ¨) --- */
  .loading, .error, .empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 3rem;
    font-size: 1.1rem;
    color: #6b7280;
  }
  .error { color: #ef4444; }
  .hidden { display: none; }
  .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }

  @media (max-width: 768px) {
    .checklist-container { padding: 1rem; }
    .items-list {
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
    }
  }
</style>

<script>
  let currentCategory = 'movies';
  let currentStatus = 'watching';
  let data = null;

  // åˆå§‹åŒ– (æ— æ”¹åŠ¨)
  document.addEventListener('DOMContentLoaded', () => {
    loadData();
    setupEventListeners();
  });

  // äº‹ä»¶ç›‘å¬ (æ— æ”¹åŠ¨)
  function setupEventListeners() {
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', (e) => switchCategory(e.target.dataset.category));
    });

    document.querySelectorAll('.status-btn').forEach(btn => {
      btn.addEventListener('click', (e) => switchStatus(e.target.dataset.status));
    });
  }

  // åˆ†ç±»åˆ‡æ¢ (æ— æ”¹åŠ¨)
  function switchCategory(category) {
    currentCategory = category;
    
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.category === category);
    });
    
    document.querySelectorAll('.status-group').forEach(group => {
      group.classList.toggle('hidden', group.dataset.category !== category);
    });
    
    const firstStatusBtn = document.querySelector(`.status-group[data-category="${category}"] .status-btn`);
    if (firstStatusBtn) {
      currentStatus = firstStatusBtn.dataset.status;
      document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
      firstStatusBtn.classList.add('active');
    }
    
    renderItems();
  }

  // çŠ¶æ€åˆ‡æ¢ (æ— æ”¹åŠ¨)
  function switchStatus(status) {
    currentStatus = status;
    document.querySelectorAll(`.status-group[data-category="${currentCategory}"] .status-btn`).forEach(btn => {
      btn.classList.toggle('active', btn.dataset.status === status);
    });
    renderItems();
  }

  // åŠ è½½æ•°æ® (ä¿ç•™äº†æµ‹è¯•æ•°æ®ä»¥é˜²APIå¤±è´¥)
  async function loadData() {
    const loading = document.querySelector('.loading');
    const error = document.querySelector('.error');
    const container = document.getElementById('items-container');
    
    loading.classList.remove('hidden');
    error.classList.add('hidden');
    container.innerHTML = '';
    
    try {
      const response = await fetch('/api/douban');
      if (!response.ok) throw new Error('Network response was not ok');
      data = await response.json();
    } catch (err) {
      console.error('Failed to load data, using fallback test data:', err);
      // Fallback test data
      data = {
        movies: {
          watching: [
            { title: "æµ‹è¯•ç”µå½±ï¼šæ˜Ÿé™…ç©¿è¶Š", poster: "https://img1.doubanio.com/view/photo/s_ratio_poster/public/p2206088801.webp", link: "#", pubDate: "2014-11-12", rating: "9.4", comment: "è¯ºå…°çš„ç§‘å¹»ç¥ä½œï¼Œäº²æƒ…ä¸å®‡å®™çš„å®å¤§å™äº‹ã€‚" },
            { title: "æµ‹è¯•ç”µå½±ï¼šç¬æ¯å…¨å®‡å®™", poster: "https://img9.doubanio.com/view/photo/s_ratio_poster/public/p2871553046.webp", link: "#", pubDate: "2022-03-25", rating: "7.6", comment: "å¤©é©¬è¡Œç©ºçš„æƒ³è±¡åŠ›ï¼Œä½†å†…æ ¸è¿˜æ˜¯å®¶åº­ã€‚" }
          ], watched: [], wantToWatch: [] },
        books: { reading: [], read: [], wantToRead: [] },
        games: { playing: [], played: [], wantToPlay: [] }
      };
    } finally {
        loading.classList.add('hidden');
        renderItems();
    }
  }

  // è¯„åˆ†ç”Ÿæˆå‡½æ•° (ä¿æŒä½ çš„ç®€åŒ–ç‰ˆ)
  function generateRating(rating) {
    const ratingValue = parseFloat(rating);
    if (isNaN(ratingValue) || ratingValue <= 0) {
      return `<div class="star-rating"><span style="color: #9ca3af; font-size: 0.8rem;">æš‚æ— è¯„åˆ†</span></div>`;
    }
    return `<div class="star-rating"><span style="color: #f59e0b; font-weight: bold; font-size: 0.9rem;">${ratingValue}</span><span style="color: #d1d5db; font-size: 0.8rem;">/10</span></div>`;
  }
  
  // --- MODIFIED: ä½¿ç”¨DOM APIåˆ›å»ºå…ƒç´ ï¼Œé¿å…XSSæ”»å‡» ---
  function renderItems() {
    const container = document.getElementById('items-container');
    const items = data?.[currentCategory]?.[currentStatus] || [];
    
    if (items.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“š</div><p>æš‚æ— å†…å®¹</p></div>';
      return;
    }
    
    // æ¸…ç©ºå®¹å™¨
    container.innerHTML = '';
    
    // å®‰å…¨åœ°åˆ›å»ºå…ƒç´ 
    items.forEach(item => {
      // æ•°æ®å®‰å…¨å¤„ç†
      const title = (item.title || 'æœªçŸ¥æ ‡é¢˜').replace(/[<>"'&]/g, (match) => {
        const escapeMap = { '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '&': '&amp;' };
        return escapeMap[match];
      });
      
      const poster = item.poster || '/images/placeholder.jpg';
      const link = item.link || '#';
      const pubDate = formatDate(item.pubDate) || 'æœªçŸ¥æ—¥æœŸ';
      const comment = (item.comment || '').replace(/[<>"'&]/g, (match) => {
        const escapeMap = { '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '&': '&amp;' };
        return escapeMap[match];
      });
      
      // åˆ›å»ºå¡ç‰‡å®¹å™¨
      const cardLink = document.createElement('a');
      cardLink.className = 'item-card';
      cardLink.href = link;
      cardLink.target = '_blank';
      cardLink.rel = 'noopener noreferrer';
      
      // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
      const img = document.createElement('img');
      img.className = 'item-poster';
      img.src = poster;
      img.alt = title;
      img.loading = 'lazy';
      img.onerror = function() {
        this.src = '/images/placeholder.jpg';
      };
      
      // ç»„è£…å¡ç‰‡
      cardLink.appendChild(img);
      
      // æ·»åŠ åˆ°å®¹å™¨
      container.appendChild(cardLink);
    });
  }

  // æ—¥æœŸæ ¼å¼åŒ– (æ— æ”¹åŠ¨)
  function formatDate(dateString) {
    if (!dateString) return '';
    try {
      const date = new Date(dateString);
      return date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
    } catch {
      return dateString;
    }
  }
</script>