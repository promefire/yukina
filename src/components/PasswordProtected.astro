---
import { encrypt } from '../utils/encrypt';

interface Props {
  password: string;
}

const { password } = Astro.props;

// è·å– slot ä¸­çš„ HTML å†…å®¹
const html = await Astro.slots.render('default');
const encryptedHtml = await encrypt(html, password);
---

<!-- å°†åŠ å¯†å†…å®¹å­˜å‚¨åœ¨ meta æ ‡ç­¾ä¸­ -->
<meta name="encrypted-content" content={encryptedHtml} />

<div id="password-protected-wrapper">
  <div id="password-form" class="password-form">
    <div class="password-container">
      <div class="lock-icon">ğŸ”’</div>
      <p>æ­¤æ–‡ç« å·²åŠ å¯†</p>
      <p>è¯·è¾“å…¥å¯†ç æŸ¥çœ‹å†…å®¹</p>
      <div class="input-group">
        <input 
          id="password-input" 
          type="password" 
          placeholder="è¯·è¾“å…¥å¯†ç "
          class="password-input"
          autocomplete="off"
          autofocus
        />
        <button id="decrypt-btn" class="decrypt-btn">è§£é”</button>
      </div>
      <div id="error-message" class="error-message" style="display: none;"></div>
    </div>
  </div>
  
  <div id="decrypted-content" class="decrypted-content" style="display: none;">
    <!-- è§£å¯†åçš„å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
  </div>
</div>

<script>
  // å®¢æˆ·ç«¯è§£å¯†å‡½æ•°
  async function decrypt(encryptedData, password) {
    try {
      const key = password.length >= 16 ? password.slice(0, 16) : password.padEnd(16, '0');
      
      const combinedData = new Uint8Array(
        atob(encryptedData).split('').map(char => char.charCodeAt(0))
      );
      
      const iv = combinedData.slice(0, 16);
      const encrypted = combinedData.slice(16);
      
      const keyBuffer = new TextEncoder().encode(key);
      const cryptoKey = await crypto.subtle.importKey(
        'raw',
        keyBuffer,
        { name: 'AES-CBC', length: 128 },
        false,
        ['decrypt']
      );
      
      const decryptedData = await crypto.subtle.decrypt(
        { name: 'AES-CBC', iv },
        cryptoKey,
        encrypted
      );
      
      return new TextDecoder().decode(decryptedData);
    } catch (error) {
      throw new Error('è§£å¯†å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†ç æ˜¯å¦æ­£ç¡®');
    }
  }

  // åˆå§‹åŒ–å‡½æ•°
  function initPasswordProtected() {
    const passwordInput = document.getElementById('password-input');
    const decryptBtn = document.getElementById('decrypt-btn');
    const errorMessage = document.getElementById('error-message');
    const passwordForm = document.getElementById('password-form');
    const decryptedContent = document.getElementById('decrypted-content');
    
    // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼Œè¯´æ˜ä¸æ˜¯åŠ å¯†é¡µé¢ï¼Œç›´æ¥è¿”å›
    if (!passwordInput || !decryptBtn || !passwordForm || !decryptedContent) {
      return;
    }
    
    // è·å–åŠ å¯†å†…å®¹
    const encryptedData = document.querySelector('meta[name="encrypted-content"]')?.getAttribute('content');
    
    if (!encryptedData) {
      showError('åŠ å¯†å†…å®¹ä¸å­˜åœ¨');
      return;
    }

    async function handleDecrypt() {
      const password = passwordInput.value.trim();
      if (!password) {
        showError('è¯·è¾“å…¥å¯†ç ');
        return;
      }

      try {
        decryptBtn.textContent = 'è§£å¯†ä¸­...';
        decryptBtn.disabled = true;
        
        const decryptedHtml = await decrypt(encryptedData, password);
        
        // éšè—å¯†ç è¡¨å•ï¼Œæ˜¾ç¤ºè§£å¯†å†…å®¹
        passwordForm.style.display = 'none';
        decryptedContent.innerHTML = decryptedHtml;
        decryptedContent.style.display = 'block';
        
        // é‡æ–°æ‰§è¡Œå¯èƒ½çš„è„šæœ¬
        const scripts = decryptedContent.querySelectorAll('script');
        scripts.forEach(script => {
          const newScript = document.createElement('script');
          if (script.src) {
            newScript.src = script.src;
          } else {
            newScript.textContent = script.textContent;
          }
          document.head.appendChild(newScript);
        });
        
      } catch (error) {
        showError(error.message || 'è§£å¯†å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†ç æ˜¯å¦æ­£ç¡®');
      } finally {
        decryptBtn.textContent = 'è§£é”';
        decryptBtn.disabled = false;
      }
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      setTimeout(() => {
        errorMessage.style.display = 'none';
      }, 3000);
    }

    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç»‘å®š
    decryptBtn.removeEventListener('click', handleDecrypt);
    passwordInput.removeEventListener('keypress', handleKeyPress);
    
    function handleKeyPress(e) {
      if (e.key === 'Enter') {
        handleDecrypt();
      }
    }

    // ç»‘å®šäº‹ä»¶
    decryptBtn.addEventListener('click', handleDecrypt);
    passwordInput.addEventListener('keypress', handleKeyPress);
  }

  // å¤šç§æ–¹å¼ç¡®ä¿åˆå§‹åŒ–
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPasswordProtected);
  } else {
    // DOMå·²ç»åŠ è½½å®Œæˆï¼Œç«‹å³æ‰§è¡Œ
    initPasswordProtected();
  }
  
  // ç›‘å¬ swup é¡µé¢åˆ‡æ¢äº‹ä»¶
  document.addEventListener('swup:enable', () => {
    if (window.swup?.hooks) {
      window.swup.hooks.on('content:replace', initPasswordProtected);
    }
  });
  
  // å¦‚æœ swup å·²ç»å¯ç”¨ï¼Œç›´æ¥æ³¨å†Œé’©å­
  if (window.swup?.hooks) {
    window.swup.hooks.on('content:replace', initPasswordProtected);
  }
</script>

<style>
  .password-form {
    @apply flex items-center justify-center min-h-[400px];
  }
  
  .password-container {
    @apply bg-[var(--card-color)] rounded-2xl p-8 text-center max-w-md mx-auto;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }
  
  .lock-icon {
    @apply text-4xl mb-4;
  }
  
  .password-container h3 {
    @apply text-2xl font-bold mb-4 text-[var(--primary-color)];
  }
  
  .password-container p {
    @apply text-[var(--text-color)] mb-6;
  }
  
  .input-group {
    @apply flex gap-2 mb-4;
  }
  
  .password-input {
    @apply flex-1 px-4 py-2 border border-[var(--border-color)] rounded-lg;
    @apply bg-[var(--bg-color)] text-[var(--text-color)];
    @apply focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)];
  }
  
  .decrypt-btn {
    @apply px-6 py-2 bg-[var(--primary-color)] text-white rounded-lg;
    @apply hover:bg-[var(--primary-color-hover)] transition-colors;
    @apply disabled:opacity-50 disabled:cursor-not-allowed;
  }
  
  .error-message {
    @apply text-red-500 text-sm mt-2;
  }
  
  .decrypted-content {
    @apply w-full;
  }
</style>